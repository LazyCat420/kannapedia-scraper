<!DOCTYPE html>
<html>
<head>
    <title>Cannabis Strain Network</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; font-family: Arial, sans-serif; }
        #sidebar { 
            width: 400px; 
            height: 100vh; 
            overflow-y: auto; 
            padding: 20px; 
            background: #f5f5f5;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #network-container { flex-grow: 1; height: 100vh; }
        .strain-card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section { margin: 15px 0; }
        pre { white-space: pre-wrap; font-size: 12px; }
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button.active {
            border-bottom-color: #2B7CE9;
            color: #2B7CE9;
        }
        
        .view {
            display: none;
            width: 100%;
            height: calc(100vh - 40px);
        }
        
        .view.active {
            display: flex;
        }
        
        #fractal-container {
            width: 100%;
            height: 100%;
            background: white;
        }
    </style>
</head>
<body>
    <div id="tabs" style="display: flex; height: 40px; background: #f0f0f0;">
        <button id="network-tab" class="tab-button active">Network View</button>
        <button id="fractal-tab" class="tab-button">Fractal View</button>
    </div>
    <div id="views" style="flex: 1; display: flex;">
        <div id="network-view" class="view active">
            <div id="sidebar">
                <input type="text" id="search-input" placeholder="Search strains...">
                <div id="strain-info">Select a strain to view details</div>
            </div>
            <div id="network-container"></div>
        </div>
        <div id="fractal-view" class="view" style="display: none;">
            <div id="fractal-container"></div>
        </div>
    </div>
    
    <script type="text/javascript">
        // Initialize data
        let nodes, allRelationships;
        try {
            nodes = new vis.DataSet({{NODES_DATA}});
            allRelationships = {{RELATIONSHIPS_DATA}};
        } catch (e) {
            console.error('Error initializing data:', e);
            nodes = new vis.DataSet([]);
            allRelationships = [];
        }
        
        // Create network
        const container = document.getElementById('network-container');
        const data = {
            nodes: nodes,
            edges: new vis.DataSet([])  // Start with empty edges
        };
        
        const options = {
            nodes: {
                shape: 'dot',
                size: 16,
                font: { 
                    size: 14,  // Slightly larger font
                    face: 'arial',
                    color: '#000000',
                    strokeWidth: 3,  // Thicker stroke for better readability
                    strokeColor: '#ffffff'  // White outline around text
                },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                width: 2,
                smooth: { type: 'continuous' },
                color: { opacity: 0.5 }
            },
            layout: {
                improvedLayout: true,
                randomSeed: 42,
                circular: {
                    enabled: true,
                    radius: 800,  // Much larger radius
                    levelDistance: 300  // More distance between levels
                }
            },
            physics: {
                enabled: true,
                stabilization: {
                    enabled: true,
                    iterations: 200,
                    updateInterval: 25
                },
                repulsion: {
                    nodeDistance: 200,  // Minimum distance between nodes
                    centralGravity: 0.1,
                    springLength: 300,
                    springConstant: 0.05,
                    damping: 0.09
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200,
                zoomView: true,
                dragView: true,
                hideEdgesOnDrag: true,
                hideEdgesOnZoom: true
            }
        };
        
        // Initialize network
        const network = new vis.Network(container, data, options);
        
        // Disable physics after initial layout
        network.once('stabilizationIterationsDone', function() {
            network.setOptions({ physics: { enabled: false } });
        });
        
        // Add zoom buttons and fit button
        const controls = document.createElement('div');
        controls.style.cssText = `
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        `;
        
        const zoomIn = document.createElement('button');
        zoomIn.textContent = 'âž•';
        zoomIn.onclick = () => network.moveTo({ scale: network.getScale() * 1.2 });
        
        const zoomOut = document.createElement('button');
        zoomOut.textContent = 'âž–';
        zoomOut.onclick = () => network.moveTo({ scale: network.getScale() * 0.8 });
        
        const fitButton = document.createElement('button');
        fitButton.textContent = 'âŸ²';
        fitButton.onclick = () => network.fit({ animation: true });
        
        const physicsButton = document.createElement('button');
        physicsButton.textContent = 'ðŸ”„';
        physicsButton.title = 'Toggle Physics';
        let physicsEnabled = false;
        physicsButton.onclick = () => {
            physicsEnabled = !physicsEnabled;
            network.setOptions({ 
                physics: { 
                    enabled: physicsEnabled,
                    stabilization: {
                        enabled: true,
                        iterations: 100,
                        updateInterval: 25
                    },
                    repulsion: {
                        nodeDistance: 200,
                        centralGravity: 0.1,
                        springLength: 300,
                        springConstant: 0.05,
                        damping: 0.09
                    }
                } 
            });
            physicsButton.style.backgroundColor = physicsEnabled ? '#e6f3ff' : 'white';
        };
        
        [zoomIn, zoomOut, fitButton, physicsButton].forEach(button => {
            button.style.cssText = `
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: none;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                cursor: pointer;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background-color 0.3s ease;
            `;
            controls.appendChild(button);
        });
        
        document.getElementById('network-container').appendChild(controls);
        
        // Keep track of currently shown edges
        let currentEdges = new Set();
        
        // Add this before the network click handler
        const activeNodes = new Set();
        
        // Add this function before the network click handler
        async function scrapeStrain(rsp) {
            if (!rsp) {
                console.error('No RSP number provided');
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('strain-info').innerHTML = `
                    <div class="strain-card">
                        <h2>Scraping Data...</h2>
                        <p>Please wait while we fetch the data for RSP: ${rsp}</p>
                    </div>
                `;
                
                // Call the scraping endpoint
                const response = await fetch(`/scrape/${rsp}`);
                const data = await response.json();
                
                if (data.success) {
                    // Refresh the node data
                    const updatedNode = nodes.get(data.strain_name);
                    if (updatedNode) {
                        nodes.update({
                            id: data.strain_name,
                            complete: true,
                            color: {
                                background: '#2B7CE9',
                                border: '#2B7CE9'
                            }
                        });
                    }
                    
                    // Display the scraped data
                    displayStrainData(data.strain_data, data.strain_name, rsp);
                } else {
                    throw new Error(data.error || 'Failed to scrape data');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('strain-info').innerHTML = `
                    <div class="strain-card">
                        <h2>Error</h2>
                        <p>Failed to scrape data: ${error.message}</p>
                        <button onclick="scrapeStrain('${rsp}')" class="strain-button">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        // Handle node clicks
        network.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                
                if (activeNodes.has(nodeId)) {
                    // Remove this node's connections
                    activeNodes.delete(nodeId);
                    // Remove only edges connected to this node
                    const edgesToRemove = [];
                    data.edges.forEach(edge => {
                        if (edge.from === nodeId || edge.to === nodeId) {
                            edgesToRemove.push(edge.id);
                            currentEdges.delete(edge.id);
                        }
                    });
                    data.edges.remove(edgesToRemove);
                } else {
                    // Add this node's connections
                    activeNodes.add(nodeId);
                    // Add edges for the clicked node
                    allRelationships.forEach(rel => {
                        if (rel.from === nodeId || rel.to === nodeId) {
                            if (rel.distance < 0.2) {  // Only show close relationships
                                const edgeId = `${rel.from}-${rel.to}`;
                                if (!currentEdges.has(edgeId)) {
                                    data.edges.add({
                                        id: edgeId,
                                        from: rel.from,
                                        to: rel.to,
                                        value: 1 - rel.distance,
                                        length: rel.distance * 400
                                    });
                                    currentEdges.add(edgeId);
                                }
                            }
                        }
                    });
                }

                // Update node appearance
                nodes.update({
                    id: nodeId,
                    color: {
                        background: activeNodes.has(nodeId) ? '#ff9999' : (node.complete ? '#2B7CE9' : '#97C2FC'),
                        border: activeNodes.has(nodeId) ? '#ff0000' : (node.complete ? '#2B7CE9' : '#97C2FC')
                    }
                });

                // Handle node data display
                if (node.complete) {
                    fetch(`/strain_data/${encodeURIComponent(nodeId)}|${encodeURIComponent(node.rsp)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                displayStrainData(data.data, nodeId, node.rsp);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                } else {
                    document.getElementById('strain-info').innerHTML = `
                        <div class="strain-card">
                            <h2>${nodeId}</h2>
                            <p>RSP: ${node.rsp}</p>
                            ${node.rsp ? `
                                <button onclick="scrapeStrain('${node.rsp}')" class="strain-button">
                                    Scrape Data
                                </button>
                            ` : '<p>No RSP number available for this strain</p>'}
                        </div>
                    `;
                }
            }
        });
        
        function displayStrainData(data, strain, rsp) {
            const { summary, chemicals, metadata } = data;
            document.getElementById('strain-info').innerHTML = `
                <div class="strain-card">
                    <h2>${strain}</h2>
                    <p><strong>RSP:</strong> ${rsp}</p>
                    
                    <div class="section">
                        <h3>General Information</h3>
                        ${Object.entries(metadata).map(([key, value]) => 
                            `<p><strong>${key}:</strong> ${value}</p>`
                        ).join('')}
                    </div>
                    
                    <div class="section">
                        <h3>Chemical Content</h3>
                        ${chemicals.map(c => 
                            `<p><strong>${c.Name}:</strong> ${c.Value}</p>`
                        ).join('')}
                    </div>
                    
                    <div class="section">
                        <h3>Genetic Information</h3>
                        <pre>${summary}</pre>
                    </div>
                </div>
            `;
        }
        
        // Add search functionality
        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const allNodes = nodes.get();
            allNodes.forEach(node => {
                const matches = node.label.toLowerCase().includes(searchTerm);
                nodes.update({
                    id: node.id,
                    opacity: matches ? 1 : 0.2
                });
            });
        });
        
        // Add some CSS for the strain button
        const style = document.createElement('style');
        style.textContent = `
            .strain-button {
                background: #2B7CE9;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-top: 10px;
            }
            .strain-button:hover {
                background: #1f5aa7;
            }
        `;
        document.head.appendChild(style);

        // Add tab switching functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active state from all tabs and views
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => {
                    v.style.display = 'none';
                    v.classList.remove('active');
                });
                
                // Activate selected tab and view
                button.classList.add('active');
                const viewId = button.id.replace('-tab', '-view');
                const view = document.getElementById(viewId);
                view.style.display = 'flex';
                view.classList.add('active');
                
                // Render fractal view if selected
                if (viewId === 'fractal-view') {
                    console.log('Active nodes:', Array.from(activeNodes));
                    renderFractalView();
                }
            });
        });

        // Update the renderFractalView function with better visualization settings
        function renderFractalView() {
            console.log('Rendering fractal view');
            const fractalContainer = document.getElementById('fractal-container');
            fractalContainer.innerHTML = '';
            
            if (activeNodes.size === 0) {
                fractalContainer.innerHTML = '<div style="padding: 20px; text-align: center;">Please select nodes in the Network View first</div>';
                return;
            }

            const fractalNodes = new vis.DataSet();
            const fractalEdges = new vis.DataSet();
            const processedNodes = new Set();

            function addNodeToFractal(nodeId, x, y, level) {
                if (level >= 3 || processedNodes.has(nodeId)) return;
                
                const node = nodes.get(nodeId);
                if (!node) return;
                
                processedNodes.add(nodeId);
                
                // Add node to fractal visualization with improved styling
                fractalNodes.add({
                    id: `${nodeId}_${level}`,
                    label: node.label || nodeId,
                    x: x,
                    y: y,
                    level: level,
                    color: {
                        background: level === 0 ? '#ff9999' : '#97C2FC',
                        border: level === 0 ? '#ff0000' : '#2B7CE9',
                        highlight: {
                            background: level === 0 ? '#ffcccc' : '#b3d1ff',
                            border: level === 0 ? '#ff3333' : '#4d88ff'
                        }
                    },
                    size: 40 - (level * 8), // Larger size difference between levels
                    font: {
                        size: 16 - (level * 2), // Text size decreases with level
                        color: '#000000',
                        strokeWidth: 2,
                        strokeColor: '#ffffff'
                    }
                });

                // Find and sort relationships
                const relationships = allRelationships
                    .filter(rel => (rel.from === nodeId || rel.to === nodeId))
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 8);

                const angleStep = (2 * Math.PI) / Math.max(relationships.length, 1);
                relationships.forEach((rel, index) => {
                    const childId = rel.from === nodeId ? rel.to : rel.from;
                    if (!processedNodes.has(childId)) {
                        const angle = index * angleStep;
                        const radius = 250 / (level + 1); // Increased base radius
                        const childX = x + radius * Math.cos(angle);
                        const childY = y + radius * Math.sin(angle);
                        
                        addNodeToFractal(childId, childX, childY, level + 1);
                        
                        fractalEdges.add({
                            from: `${nodeId}_${level}`,
                            to: `${childId}_${level + 1}`,
                            length: radius,
                            width: 3 - (level * 0.5),
                            color: { 
                                color: '#2B7CE9',
                                opacity: 0.8 - (level * 0.2) 
                            },
                            smooth: {
                                type: 'continuous',
                                roundness: 0.5
                            },
                            title: `Genetic Distance: ${rel.distance.toFixed(3)}`
                        });
                    }
                });
            }

            // Initialize root nodes with larger spacing
            Array.from(activeNodes).forEach((nodeId, index) => {
                const angle = (index * 2 * Math.PI) / activeNodes.size;
                const x = 400 * Math.cos(angle); // Increased radius for root nodes
                const y = 400 * Math.sin(angle);
                addNodeToFractal(nodeId, x, y, 0);
            });

            // Create the fractal network with improved options
            const fractalNetwork = new vis.Network(fractalContainer, {
                nodes: fractalNodes,
                edges: fractalEdges
            }, {
                physics: {
                    enabled: true,
                    stabilization: {
                        enabled: true,
                        iterations: 200,
                        updateInterval: 25
                    },
                    hierarchicalRepulsion: {
                        nodeDistance: 200,
                        springLength: 200,
                        springConstant: 0.01,
                        damping: 0.09
                    }
                },
                interaction: {
                    dragNodes: true,
                    dragView: true,
                    zoomView: true,
                    hover: true,
                    tooltipDelay: 200
                },
                layout: {
                    improvedLayout: true
                }
            });

            // Add controls to the fractal view
            const fractalControls = document.createElement('div');
            fractalControls.style.cssText = `
                position: absolute;
                bottom: 20px;
                right: 20px;
                display: flex;
                gap: 10px;
            `;

            const fitButton = document.createElement('button');
            fitButton.textContent = 'âŸ²';
            fitButton.onclick = () => fractalNetwork.fit({ animation: true });
            fitButton.style.cssText = `
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: none;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                cursor: pointer;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            fractalControls.appendChild(fitButton);
            fractalContainer.appendChild(fractalControls);

            // Disable physics after initial layout
            fractalNetwork.once('stabilizationIterationsDone', () => {
                fractalNetwork.setOptions({ physics: { enabled: false } });
            });
        }
    </script>
</body>
</html> 