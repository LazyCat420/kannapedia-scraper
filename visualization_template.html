<!DOCTYPE html>
<html>
<head>
    <title>Cannabis Strain Network</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { margin: 0; padding: 0; display: flex; font-family: Arial, sans-serif; }
        #sidebar { 
            width: 400px; 
            height: 100vh; 
            overflow-y: auto; 
            padding: 20px; 
            background: #f5f5f5;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #network-container { flex-grow: 1; height: 100vh; }
        .strain-card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section { margin: 15px 0; }
        pre { white-space: pre-wrap; font-size: 12px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <input type="text" id="search-input" placeholder="Search strains...">
        <div id="strain-info">Select a strain to view details</div>
    </div>
    <div id="network-container"></div>
    
    <script type="text/javascript">
        // Initialize data
        const nodes = new vis.DataSet({{NODES_DATA}});
        const allRelationships = {{RELATIONSHIPS_DATA}};
        
        // Create network
        const container = document.getElementById('network-container');
        const data = {
            nodes: nodes,
            edges: new vis.DataSet([])  // Start with empty edges
        };
        
        const options = {
            nodes: {
                shape: 'dot',
                size: 16,
                font: { 
                    size: 14,  // Slightly larger font
                    face: 'arial',
                    color: '#000000',
                    strokeWidth: 3,  // Thicker stroke for better readability
                    strokeColor: '#ffffff'  // White outline around text
                },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                width: 2,
                smooth: { type: 'continuous' },
                color: { opacity: 0.5 }
            },
            layout: {
                improvedLayout: true,
                randomSeed: 42,
                circular: {
                    enabled: true,
                    radius: 800,  // Much larger radius
                    levelDistance: 300  // More distance between levels
                }
            },
            physics: {
                enabled: true,
                stabilization: {
                    enabled: true,
                    iterations: 200,
                    updateInterval: 25
                },
                repulsion: {
                    nodeDistance: 200,  // Minimum distance between nodes
                    centralGravity: 0.1,
                    springLength: 300,
                    springConstant: 0.05,
                    damping: 0.09
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200,
                zoomView: true,
                dragView: true,
                hideEdgesOnDrag: true,
                hideEdgesOnZoom: true
            }
        };
        
        // Initialize network
        const network = new vis.Network(container, data, options);
        
        // Disable physics after initial layout
        network.once('stabilizationIterationsDone', function() {
            network.setOptions({ physics: { enabled: false } });
        });
        
        // Add zoom buttons and fit button
        const controls = document.createElement('div');
        controls.style.cssText = `
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        `;
        
        const zoomIn = document.createElement('button');
        zoomIn.textContent = '➕';
        zoomIn.onclick = () => network.moveTo({ scale: network.getScale() * 1.2 });
        
        const zoomOut = document.createElement('button');
        zoomOut.textContent = '➖';
        zoomOut.onclick = () => network.moveTo({ scale: network.getScale() * 0.8 });
        
        const fitButton = document.createElement('button');
        fitButton.textContent = '⟲';
        fitButton.onclick = () => network.fit({ animation: true });
        
        [zoomIn, zoomOut, fitButton].forEach(button => {
            button.style.cssText = `
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: none;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                cursor: pointer;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            controls.appendChild(button);
        });
        
        document.getElementById('network-container').appendChild(controls);
        
        // Keep track of currently shown edges
        let currentEdges = new Set();
        
        // Handle node clicks
        network.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                
                // Clear previous edges
                data.edges.clear();
                currentEdges.clear();
                
                // Add edges for the clicked node
                allRelationships.forEach(rel => {
                    if (rel.from === nodeId || rel.to === nodeId) {
                        if (rel.distance < 0.2) {  // Only show close relationships
                            const edgeId = `${rel.from}-${rel.to}`;
                            if (!currentEdges.has(edgeId)) {
                                data.edges.add({
                                    id: edgeId,
                                    from: rel.from,
                                    to: rel.to,
                                    value: 1 - rel.distance,
                                    length: rel.distance * 400
                                });
                                currentEdges.add(edgeId);
                            }
                        }
                    }
                });

                if (node.complete) {
                    fetch(`/strain_data/${encodeURIComponent(nodeId)}|${encodeURIComponent(node.rsp)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                displayStrainData(data.data, nodeId, node.rsp);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                } else {
                    document.getElementById('strain-info').innerHTML = `
                        <div class="strain-card">
                            <h2>${nodeId}</h2>
                            <p>RSP: ${node.rsp}</p>
                            <button onclick="scrapeStrain('${node.rsp}')" class="strain-button">
                                Scrape Data
                            </button>
                        </div>
                    `;
                }
            } else {
                // Clear edges when clicking on empty space
                data.edges.clear();
                currentEdges.clear();
            }
        });
        
        function displayStrainData(data, strain, rsp) {
            const { summary, chemicals, metadata } = data;
            document.getElementById('strain-info').innerHTML = `
                <div class="strain-card">
                    <h2>${strain}</h2>
                    <p><strong>RSP:</strong> ${rsp}</p>
                    
                    <div class="section">
                        <h3>General Information</h3>
                        ${Object.entries(metadata).map(([key, value]) => 
                            `<p><strong>${key}:</strong> ${value}</p>`
                        ).join('')}
                    </div>
                    
                    <div class="section">
                        <h3>Chemical Content</h3>
                        ${chemicals.map(c => 
                            `<p><strong>${c.Name}:</strong> ${c.Value}</p>`
                        ).join('')}
                    </div>
                    
                    <div class="section">
                        <h3>Genetic Information</h3>
                        <pre>${summary}</pre>
                    </div>
                </div>
            `;
        }
        
        // Add search functionality
        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const allNodes = nodes.get();
            allNodes.forEach(node => {
                const matches = node.label.toLowerCase().includes(searchTerm);
                nodes.update({
                    id: node.id,
                    opacity: matches ? 1 : 0.2
                });
            });
        });
    </script>
</body>
</html> 